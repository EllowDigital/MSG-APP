<!DOCTYPE html>
<html lang="en" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Messaging Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Simple transition for dark mode */
        body,
        .bg-white,
        .bg-gray-50,
        .bg-gray-100 {
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Custom focus rings for better accessibility */
        .focus-ring {
            @apply focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:focus:ring-offset-gray-800;
        }
    </style>
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Messaging Dashboard</h1>
                <p class="text-gray-600 dark:text-gray-400 mt-1">Send SMS, WhatsApp, and Voice campaigns with advanced
                    controls.</p>
            </div>
            <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 focus-ring">
                <!-- Sun Icon -->
                <svg id="theme-icon-light" class="h-6 w-6 text-gray-800" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                <!-- Moon Icon -->
                <svg id="theme-icon-dark" class="h-6 w-6 text-gray-200 hidden" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
            </button>
        </header>

        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl">
            <!-- Channel Selection -->
            <div class="mb-6">
                <label for="channel" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">1. Select
                    Channel</label>
                <select id="channel"
                    class="w-full p-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus-ring">
                    <option value="sms">SMS</option>
                    <option value="whatsapp">WhatsApp</option>
                    <option value="call">Voice Call</option>
                </select>
            </div>

            <!-- Message Input -->
            <div class="mb-6">
                <label for="message" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">2. Compose
                    Message</label>
                <textarea id="message" rows="4"
                    class="w-full p-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus-ring"
                    placeholder="Enter your message here... For voice calls, this text will be read out."></textarea>
            </div>

            <!-- Contacts Input -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">3. Add Contacts</label>
                <div class="p-4 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-md text-center">
                    <input type="file" id="csvFile" accept=".csv" class="hidden">
                    <button onclick="document.getElementById('csvFile').click()"
                        class="bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 font-semibold py-2 px-4 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition focus-ring">
                        Upload CSV File
                    </button>
                    <p id="file-info" class="text-sm text-gray-500 dark:text-gray-400 mt-2">Upload a CSV with a 'phone'
                        column.</p>
                </div>
                <textarea id="manual-numbers"
                    class="w-full mt-4 p-3 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus-ring"
                    rows="3" placeholder="Or paste numbers here, one per line (e.g., +919876543210)"></textarea>
            </div>

            <!-- Campaign Controls -->
            <div class="mb-6">
                <label for="delay-slider" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">4.
                    Sending Speed</label>
                <div class="flex items-center gap-4">
                    <span class="text-xs">Fast</span>
                    <input id="delay-slider" type="range" min="200" max="5000" value="1000"
                        class="w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer">
                    <span class="text-xs">Slow</span>
                </div>
                <p class="text-sm text-gray-500 dark:text-gray-400 text-center mt-1">Delay: <span
                        id="delay-value">1</span> second(s) per message</p>
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <button id="send-button"
                    class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-md hover:bg-indigo-700 transition disabled:bg-indigo-400 dark:disabled:bg-indigo-800 focus-ring">
                    Start Campaign
                </button>
                <button id="pause-resume-button"
                    class="w-full bg-yellow-500 text-white font-bold py-3 px-4 rounded-md hover:bg-yellow-600 transition disabled:bg-yellow-300 dark:disabled:bg-yellow-800 focus-ring"
                    disabled>
                    Pause
                </button>
                <button id="stop-button"
                    class="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-md hover:bg-red-700 transition disabled:bg-red-300 dark:disabled:bg-red-800 focus-ring"
                    disabled>
                    Stop
                </button>
            </div>
        </div>

        <!-- Status Section -->
        <div id="status-container" class="mt-8 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl hidden">
            <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Campaign Status</h2>
            <div class="space-y-3">
                <p><strong>Status:</strong> <span id="status-message">Idle</span></p>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full transition-all duration-300"
                        style="width: 0%"></div>
                </div>
                <p><span id="sent-count">0</span> / <span id="total-count">0</span> messages sent.</p>
            </div>
            <div id="logs"
                class="mt-4 bg-gray-50 dark:bg-gray-900 p-3 rounded-md h-48 overflow-y-auto border border-gray-200 dark:border-gray-700">
                <!-- Log messages appear here -->
            </div>
        </div>
    </div>

    <script>
        // --- DOM Element Selection ---
        const channelSelect = document.getElementById('channel');
        const messageTextarea = document.getElementById('message');
        const csvFileInput = document.getElementById('csvFile');
        const manualNumbersTextarea = document.getElementById('manual-numbers');
        const sendButton = document.getElementById('send-button');
        const fileInfo = document.getElementById('file-info');
        const pauseResumeButton = document.getElementById('pause-resume-button');
        const stopButton = document.getElementById('stop-button');
        const delaySlider = document.getElementById('delay-slider');
        const delayValue = document.getElementById('delay-value');

        const statusContainer = document.getElementById('status-container');
        const statusMessage = document.getElementById('status-message');
        const progressBar = document.getElementById('progress-bar');
        const sentCountEl = document.getElementById('sent-count');
        const totalCountEl = document.getElementById('total-count');
        const logsContainer = document.getElementById('logs');

        // --- Dark Mode Toggle ---
        const themeToggle = document.getElementById('theme-toggle');
        const lightIcon = document.getElementById('theme-icon-light');
        const darkIcon = document.getElementById('theme-icon-dark');

        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            lightIcon.classList.add('hidden');
            darkIcon.classList.remove('hidden');
        } else {
            document.documentElement.classList.remove('dark');
        }

        themeToggle.addEventListener('click', () => {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
                lightIcon.classList.remove('hidden');
                darkIcon.classList.add('hidden');
            } else {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
                lightIcon.classList.add('hidden');
                darkIcon.classList.remove('hidden');
            }
        });

        // --- Campaign State Management ---
        let campaignState = {
            numbers: [],
            isPaused: false,
            isStopped: false,
            currentIndex: 0,
            sentCount: 0,
            totalCount: 0,
            timeoutId: null
        };

        // --- Event Listeners ---
        csvFileInput.addEventListener('change', handleCsvUpload);
        sendButton.addEventListener('click', startCampaign);
        pauseResumeButton.addEventListener('click', togglePauseResume);
        stopButton.addEventListener('click', stopCampaign);
        delaySlider.addEventListener('input', (e) => {
            delayValue.textContent = (e.target.value / 1000).toFixed(1);
        });

        // --- Core Functions ---

        function handleCsvUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            fileInfo.textContent = `File: ${file.name}`;

            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const rows = text.split('\n').map(row => row.trim()).filter(Boolean);
                const header = rows[0].split(',').map(h => h.trim().toLowerCase());
                const phoneIndex = header.indexOf('phone');

                if (phoneIndex === -1) {
                    addLog("Error: CSV must have a 'phone' column.", "error");
                    return;
                }

                campaignState.numbers = rows.slice(1).map(row => {
                    const values = row.split(',');
                    return values[phoneIndex]?.trim();
                }).filter(Boolean);

                addLog(`Loaded ${campaignState.numbers.length} numbers from CSV.`, "success");
            };
            reader.readAsText(file);
        }

        function startCampaign() {
            const manualNumbers = manualNumbersTextarea.value.split('\n').map(n => n.trim()).filter(Boolean);
            const allNumbers = [...new Set([...campaignState.numbers, ...manualNumbers])];

            if (allNumbers.length === 0) {
                addLog("Error: No phone numbers to send to.", "error");
                return;
            }
            if (!messageTextarea.value) {
                addLog("Error: Message cannot be empty.", "error");
                return;
            }

            // Validate numbers (+91XXXXXXXXXX format)
            const validNumbers = allNumbers.filter(n => /^\+91[6-9]\d{9}$/.test(n));
            const invalidNumbers = allNumbers.filter(n => !/^\+91[6-9]\d{9}$/.test(n));

            if (invalidNumbers.length > 0) {
                addLog(`Warning: Skipped ${invalidNumbers.length} invalid numbers (must be +91 format).`, 'warning');
            }
            if (validNumbers.length === 0) {
                addLog("Error: No valid phone numbers found.", "error");
                return;
            }

            // Reset and initialize campaign state
            resetCampaignState();
            campaignState.totalCount = validNumbers.length;
            campaignState.numbers = validNumbers;

            // UI update for campaign start
            statusContainer.classList.remove('hidden');
            logsContainer.innerHTML = '';
            addLog(`Starting campaign for ${validNumbers.length} numbers via ${channelSelect.value.toUpperCase()}.`);
            updateUIForCampaignStart();

            // Start the sending loop
            sendNextMessage();
        }

        async function sendNextMessage() {
            if (campaignState.currentIndex >= campaignState.totalCount || campaignState.isStopped) {
                finishCampaign();
                return;
            }
            if (campaignState.isPaused) {
                return; // Stop the loop if paused
            }

            const number = campaignState.numbers[campaignState.currentIndex];
            const channel = channelSelect.value;
            const message = messageTextarea.value;

            try {
                // IMPORTANT: Replace with your deployed Render URL
                const response = await fetch('https://my-bulk-messaging-server.onrender.com/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ channel, message, recipient: number }),
                });

                const result = await response.json();
                if (response.ok) {
                    campaignState.sentCount++;
                    addLog(`Successfully sent to ${number}. SID: ${result.sid}`, 'success');
                } else {
                    throw new Error(result.error || 'Unknown server error');
                }
            } catch (error) {
                addLog(`Failed to send to ${number}. Reason: ${error.message}`, 'error');
            }

            campaignState.currentIndex++;
            updateProgress();

            // Schedule the next message
            const delay = parseInt(delaySlider.value, 10);
            campaignState.timeoutId = setTimeout(sendNextMessage, delay);
        }

        function togglePauseResume() {
            campaignState.isPaused = !campaignState.isPaused;
            if (campaignState.isPaused) {
                clearTimeout(campaignState.timeoutId);
                pauseResumeButton.textContent = 'Resume';
                pauseResumeButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                pauseResumeButton.classList.add('bg-green-500', 'hover:bg-green-600');
                statusMessage.textContent = 'Paused';
                addLog('Campaign paused by user.', 'warning');
            } else {
                pauseResumeButton.textContent = 'Pause';
                pauseResumeButton.classList.remove('bg-green-500', 'hover:bg-green-600');
                pauseResumeButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                statusMessage.textContent = 'Sending...';
                addLog('Campaign resumed by user.');
                sendNextMessage(); // Continue where we left off
            }
        }

        function stopCampaign() {
            campaignState.isStopped = true;
            clearTimeout(campaignState.timeoutId);
            addLog('Campaign stopped by user.', 'error');
            finishCampaign();
        }

        // --- UI and State Helpers ---
        function updateUIForCampaignStart() {
            sendButton.disabled = true;
            pauseResumeButton.disabled = false;
            stopButton.disabled = false;
            statusMessage.textContent = 'Sending...';
            sentCountEl.textContent = '0';
            totalCountEl.textContent = campaignState.totalCount;
            progressBar.style.width = '0%';
        }

        function updateUIForCampaignEnd() {
            sendButton.disabled = false;
            pauseResumeButton.disabled = true;
            stopButton.disabled = true;
            pauseResumeButton.textContent = 'Pause';
            pauseResumeButton.classList.remove('bg-green-500', 'hover:bg-green-600');
            pauseResumeButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
        }

        function updateProgress() {
            sentCountEl.textContent = campaignState.sentCount;
            const progressPercentage = (campaignState.currentIndex / campaignState.totalCount) * 100;
            progressBar.style.width = `${progressPercentage}%`;
        }

        function finishCampaign() {
            const finalStatus = campaignState.isStopped ? 'Stopped' : 'Finished';
            statusMessage.textContent = `Campaign ${finalStatus}`;
            addLog(`Campaign ${finalStatus}. Successfully sent to ${campaignState.sentCount} out of ${campaignState.totalCount}.`);
            updateUIForCampaignEnd();
        }

        function resetCampaignState() {
            campaignState.isPaused = false;
            campaignState.isStopped = false;
            campaignState.currentIndex = 0;
            campaignState.sentCount = 0;
            campaignState.totalCount = 0;
            if (campaignState.timeoutId) clearTimeout(campaignState.timeoutId);
        }

        function addLog(message, type = 'info') {
            const logEntry = document.createElement('p');
            const typeClasses = {
                error: 'text-red-500 dark:text-red-400',
                success: 'text-green-600 dark:text-green-400',
                warning: 'text-yellow-600 dark:text-yellow-400',
                info: 'text-gray-600 dark:text-gray-300'
            };
            logEntry.className = `text-sm ${typeClasses[type] || typeClasses.info}`;
            logEntry.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            logsContainer.prepend(logEntry);
        }
    </script>
</body>

</html>