<!DOCTYPE html>
<html lang="en" class="light scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Messaging Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .focus-ring {
            @apply focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:focus:ring-offset-gray-900;
        }

        .shake {
            animation: shake 0.5s;
        }

        @keyframes shake {

            10%,
            90% {
                transform: translate3d(-1px, 0, 0);
            }

            20%,
            80% {
                transform: translate3d(2px, 0, 0);
            }

            30%,
            50%,
            70% {
                transform: translate3d(-4px, 0, 0);
            }

            40%,
            60% {
                transform: translate3d(4px, 0, 0);
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background-color: #a0aec0;
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: content-box;
        }

        html.dark ::-webkit-scrollbar-thumb {
            background-color: #4a5568;
        }

        /* Recording animation */
        .recording-dot {
            width: 10px;
            height: 10px;
            background-color: #ef4444;
            /* red-500 */
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        /* Style for the file input button */
        input[type="file"]::file-selector-button {
            @apply px-3 py-2 text-sm font-semibold bg-indigo-50 dark:bg-gray-700 text-indigo-700 dark:text-indigo-300 border border-indigo-200 dark:border-gray-600 rounded-md cursor-pointer hover:bg-indigo-100 dark:hover:bg-gray-600;
        }

        /* Loading spinner */
        .spinner {
            border: 2px solid #e5e7eb;
            /* gray-200 */
            border-top-color: #4f46e5;
            /* indigo-600 */
            border-radius: 50%;
            width: 1rem;
            height: 1rem;
            animation: spin 1s linear infinite;
        }

        html.dark .spinner {
            border-color: #4b5563;
            /* gray-600 */
            border-top-color: #818cf8;
            /* indigo-400 */
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300 antialiased">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 flex flex-col min-h-screen">
        <!-- Header -->
        <header
            class="sticky top-0 z-40 bg-gray-50/70 dark:bg-gray-900/70 backdrop-blur-lg -mx-4 sm:-mx-6 lg:-mx-8 px-4 sm:px-6 lg:px-8 py-6 border-b border-gray-200 dark:border-gray-700/50 flex justify-between items-center">
            <div class="flex items-center gap-3 sm:gap-4">
                <div class="bg-indigo-100 dark:bg-indigo-900/50 p-3 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg"
                        class="h-6 w-6 sm:h-7 sm:w-7 text-indigo-600 dark:text-indigo-400" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a2 2 0 01-2-2V7a2 2 0 012-2h6l2-2h2l-2 2z" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white">Messaging Dashboard</h1>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Launch your campaigns seamlessly.</p>
                </div>
            </div>
            <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 focus-ring">
                <svg id="theme-icon-light" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                <svg id="theme-icon-dark" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
            </button>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-5 gap-6 lg:gap-8 items-start pt-8 flex-grow">

            <div class="lg:col-span-3 space-y-8">
                <!-- Step 1: Compose Campaign -->
                <div
                    class="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700">
                    <div class="flex items-center gap-4 mb-6">
                        <span
                            class="flex items-center justify-center w-10 h-10 rounded-full bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-300 font-bold text-lg">1</span>
                        <h2 class="text-2xl font-semibold text-gray-900 dark:text-white">Compose Campaign</h2>
                    </div>
                    <div class="space-y-5">
                        <!-- Channel Selector -->
                        <div>
                            <label for="channel"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300">Channel</label>
                            <select id="channel"
                                class="mt-1 block w-full p-3 bg-gray-50 dark:bg-gray-700/50 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus-ring focus:border-indigo-500 focus:ring-indigo-500"></select>
                        </div>

                        <!-- SMS/WhatsApp Options -->
                        <div id="sms-whatsapp-options-container" class="space-y-5">
                            <div>
                                <label for="message"
                                    class="block text-sm font-medium text-gray-700 dark:text-gray-300">Message</label>
                                <textarea id="message" rows="4"
                                    class="mt-1 block w-full p-3 bg-gray-50 dark:bg-gray-700/50 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus-ring focus:border-indigo-500 focus:ring-indigo-500"
                                    placeholder="Enter your message..."></textarea>
                            </div>

                            <!-- Updated Image Upload Area -->
                            <div class="space-y-2">
                                <label for="image-url"
                                    class="block text-sm font-medium text-gray-700 dark:text-gray-300">Optional Image
                                    URL</label>
                                <input type="text" id="image-url"
                                    class="block w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm"
                                    placeholder="Auto-filled after image upload..." readonly>

                                <div
                                    class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-200 dark:border-gray-600 space-y-3">
                                    <h4 class="text-xs font-medium text-gray-600 dark:text-gray-300">Upload Image File
                                        (Optional)</h4>
                                    <img id="image-preview" src="" alt="Image Preview"
                                        class="max-h-40 rounded-md hidden mx-auto mb-2">
                                    <input type="file" id="image-file-picker" accept="image/*"
                                        class="text-sm text-gray-500 dark:text-gray-400">
                                    <div id="image-upload-status"
                                        class="hidden items-center gap-2 text-sm font-medium text-indigo-600 dark:text-indigo-400">
                                        <div class="spinner w-4 h-4"></div>
                                        <span id="image-upload-status-text">Uploading image...</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Voice Call Options -->
                        <div id="voice-call-options-container" class="hidden space-y-5">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Call Content
                                    Type</label>
                                <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-3">
                                    <label for="call-type-tts"
                                        class="relative flex items-center p-3 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-400 dark:has-[:checked]:bg-gray-700/50">
                                        <input type="radio" id="call-type-tts" name="call-type" value="tts"
                                            class="h-4 w-4 text-indigo-600 focus-ring" checked>
                                        <span
                                            class="ml-3 text-sm font-medium text-gray-800 dark:text-gray-200">Text-to-Speech</span>
                                    </label>
                                    <label for="call-type-audio"
                                        class="relative flex items-center p-3 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-400 dark:has-[:checked]:bg-gray-700/50">
                                        <input type="radio" id="call-type-audio" name="call-type" value="audio"
                                            class="h-4 w-4 text-indigo-600 focus-ring">
                                        <span class="ml-3 text-sm font-medium text-gray-800 dark:text-gray-200">Audio
                                            File</span>
                                    </label>
                                </div>
                            </div>

                            <!-- 1. TTS Container -->
                            <div id="tts-container">
                                <label for="message-tts"
                                    class="block text-sm font-medium text-gray-700 dark:text-gray-300">Message to
                                    Speak</label>
                                <textarea id="message-tts" rows="4"
                                    class="mt-1 block w-full p-3 bg-gray-50 dark:bg-gray-700/50 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus-ring focus:border-indigo-500 focus:ring-indigo-500"
                                    placeholder="Enter the text your call will speak..."></textarea>
                            </div>

                            <!-- 2. Audio File Container -->
                            <div id="audio-container" class="hidden space-y-5">
                                <div>
                                    <label for="audio-url"
                                        class="block text-sm font-medium text-gray-700 dark:text-gray-300">Public Audio
                                        URL</label>
                                    <input type="text" id="audio-url"
                                        class="mt-1 block w-full p-3 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500"
                                        placeholder="Auto-filled after audio upload..." readonly>
                                </div>

                                <div
                                    class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-200 dark:border-gray-600 space-y-4">
                                    <h4 class="text-sm font-medium text-gray-600 dark:text-gray-300">Upload Audio File
                                    </h4>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">Record (max 30s) or select an
                                        audio file. It will be automatically uploaded and the URL filled above.</p>

                                    <audio id="audio-preview" controls class="w-full"></audio>

                                    <!-- File Picker -->
                                    <div>
                                        <label for="audio-file-picker"
                                            class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Upload
                                            from file:</label>
                                        <input type="file" id="audio-file-picker" accept="audio/*"
                                            class="text-sm text-gray-500 dark:text-gray-400">
                                    </div>

                                    <!-- Live Recorder -->
                                    <div>
                                        <label
                                            class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Record
                                            live (max 30s):</label>
                                        <div class="flex items-center flex-wrap gap-3">
                                            <button id="record-button"
                                                class="flex items-center justify-center gap-2 flex-grow sm:flex-grow-0 px-4 py-2 bg-red-600 text-white font-semibold rounded-md hover:bg-red-700 focus-ring">
                                                <div class="recording-dot w-2 h-2 bg-white rounded-full"></div>
                                                <span>Record</span>
                                            </button>
                                            <button id="stop-record-button"
                                                class="flex-grow sm:flex-grow-0 px-4 py-2 bg-gray-600 text-white font-semibold rounded-md hover:bg-gray-700 focus-ring"
                                                disabled>Stop</button>
                                            <span id="record-timer"
                                                class="text-sm font-mono text-gray-700 dark:text-gray-300">00:00</span>
                                        </div>
                                    </div>

                                    <!-- Upload Status -->
                                    <div id="audio-upload-status"
                                        class="hidden items-center gap-2 text-sm font-medium text-indigo-600 dark:text-indigo-400">
                                        <div class="spinner w-4 h-4"></div>
                                        <span id="audio-upload-status-text">Uploading audio...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Add Contacts -->
                <div
                    class="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700">
                    <div class="flex items-center gap-4 mb-6">
                        <span
                            class="flex items-center justify-center w-10 h-10 rounded-full bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-300 font-bold text-lg">2</span>
                        <h2 class="text-2xl font-semibold text-gray-900 dark:text-white">Add Contacts</h2>
                    </div>
                    <div class="space-y-5">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Add Number
                                Manually</label>
                            <div class="mt-1 flex flex-col sm:flex-row gap-2">
                                <div class="flex sm:flex-none gap-2">
                                    <input type="text" id="country-code" value="+91"
                                        class="w-20 p-2 bg-gray-50 dark:bg-gray-700/50 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus-ring focus:border-indigo-500"
                                        placeholder="e.g., +91">
                                    <input type="tel" id="phone-number"
                                        class="flex-grow p-2 bg-gray-50 dark:bg-gray-700/50 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus-ring focus:border-indigo-500"
                                        placeholder="9876543210">
                                </div>
                                <button id="add-number-btn"
                                    class="w-full sm:w-auto flex-shrink-0 px-4 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700 focus-ring flex items-center justify-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                        fill="currentColor">
                                        <path fill-rule="evenodd"
                                            d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
                                            clip-rule="evenodd" />
                                    </svg>
                                    <span>Add</span>
                                </button>
                            </div>
                            <p id="add-number-feedback" class="text-xs text-red-500 mt-1 h-4"></p>
                        </div>

                        <div class="relative w-full text-center">
                            <div class="p-2 flex items-center">
                                <span class="flex-grow bg-gray-200 dark:bg-gray-700 h-px"></span>
                                <span class="mx-4 text-sm font-medium text-gray-500 dark:text-gray-400">OR</span>
                                <span class="flex-grow bg-gray-200 dark:bg-gray-700 h-px"></span>
                            </div>
                        </div>

                        <div id="csv-dropzone"
                            class="relative p-6 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg text-center cursor-pointer hover:border-indigo-500 dark:hover:border-indigo-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors"
                            onclick="document.getElementById('csvFile').click()">
                            <input type="file" id="csvFile" accept=".csv" class="hidden">
                            <div class="flex flex-col items-center justify-center text-gray-500 dark:text-gray-400">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                    class="h-10 w-10 mb-2 text-gray-400 dark:text-gray-500" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                </svg>
                                <p class="font-semibold text-indigo-600 dark:text-indigo-400">Click to upload or drag
                                    and drop</p>
                                <p id="file-info" class="text-sm mt-1">Upload a CSV with a 'phone' column.</p>
                            </div>
                        </div>

                        <div id="contacts-list-container"
                            class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                            <h3 class="font-medium text-gray-700 dark:text-gray-300">Contacts List (<span
                                    id="contact-count">0</span>)</h3>
                            <div id="contacts-list"
                                class="mt-2 p-2 border dark:border-gray-600 rounded-md max-h-48 overflow-y-auto space-y-2 bg-gray-50 dark:bg-gray-900/50">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Configure & Launch -->
                <div
                    class="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700">
                    <div class="flex items-center gap-4 mb-6">
                        <span
                            class="flex items-center justify-center w-10 h-10 rounded-full bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-300 font-bold text-lg">3</span>
                        <h2 class="text-2xl font-semibold text-gray-900 dark:text-white">Configure & Launch</h2>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Sending
                            Speed</label>
                        <div class="flex items-center gap-4">
                            <span class="text-xs font-medium text-green-600">Fast</span>
                            <input id="delay-slider" type="range" min="200" max="5000" value="1000"
                                class="w-full h-2 bg-gray-200 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer">
                            <span class="text-xs font-medium text-red-500">Slow</span>
                        </div>
                        <p class="text-sm text-gray-500 dark:text-gray-400 text-center mt-1">Delay: <span
                                id="delay-value" class="font-semibold">1.0</span>s per message</p>
                    </div>
                    <div id="cost-estimator" class="mt-6 p-4 bg-indigo-50 dark:bg-gray-700/50 rounded-lg text-center">
                        <p class="font-medium">Estimated Cost: <span id="estimated-cost"
                                class="text-indigo-600 dark:text-indigo-400 font-bold text-lg">₹0.00</span></p>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Based on standard India pricing. Media
                            messages may cost more.</p>
                    </div>
                    <div class="mt-6 space-y-3">
                        <button id="send-button"
                            class="w-full flex items-center justify-center w-full gap-2 bg-indigo-600 text-white font-bold py-3 px-4 rounded-md hover:bg-indigo-700 transition disabled:bg-indigo-400 disabled:cursor-not-allowed focus-ring">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path
                                    d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                            </svg>
                            <span>Start Campaign</span>
                        </button>
                        <div class="grid grid-cols-2 gap-3">
                            <button id="pause-resume-button"
                                class="w-full flex items-center justify-center w-full gap-2 bg-yellow-500 text-white font-bold py-3 px-4 rounded-md hover:bg-yellow-600 transition disabled:opacity-50 disabled:cursor-not-allowed focus-ring"
                                disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z"
                                        clip-rule="evenodd" />
                                </svg>
                                <span>Pause</span>
                            </button>
                            <button id="stop-button"
                                class="w-full flex items-center justify-center w-full gap-2 bg-red-600 text-white font-bold py-3 px-4 rounded-md hover:bg-red-700 transition disabled:opacity-50 disabled:cursor-not-allowed focus-ring"
                                disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                    fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z"
                                        clip-rule="evenodd" />
                                </svg>
                                <span>Stop</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Container -->
            <div id="status-container"
                class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 lg:sticky lg:top-32">
                <h2 class="text-2xl font-semibold mb-4 text-gray-900 dark:text-white">Live Campaign Status</h2>
                <div class="border-b border-gray-200 dark:border-gray-700 mb-4">
                    <nav class="-mb-px flex space-x-4 sm:space-x-6" aria-label="Tabs">
                        <button id="tab-logs"
                            class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600 dark:text-indigo-400">Logs</button>
                        <button id="tab-failures"
                            class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-200">
                            Failures (<span id="failure-count">0</span>)
                        </button>
                    </nav>
                </div>
                <div id="tab-content-logs">
                    <div class="space-y-3">
                        <p><strong>Status:</strong> <span id="status-message" aria-live="polite"
                                class="font-semibold text-indigo-600 dark:text-indigo-400">Idle. Configure a campaign to
                                begin.</span></p>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                            <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full transition-all duration-300"
                                style="width: 0%"></div>
                        </div>
                        <p class="text-sm text-center font-medium"><span id="sent-count">0</span> / <span
                                id="total-count">0</span> messages processed.</p>
                    </div>
                    <div id="logs"
                        class="mt-4 bg-gray-50 dark:bg-gray-900/50 p-3 rounded-md h-80 sm:h-96 overflow-y-auto border border-gray-200 dark:border-gray-700 scroll-smooth">
                    </div>
                </div>
                <div id="tab-content-failures" class="hidden">
                    <p class="text-sm mb-2 text-gray-600 dark:text-gray-400">Numbers that failed to send will appear
                        here for retrying.</p>
                    <textarea id="failed-numbers"
                        class="w-full p-3 font-mono text-sm bg-gray-50 dark:bg-gray-900/50 border border-gray-200 dark:border-gray-700 rounded-md shadow-sm h-80 sm:h-96"
                        readonly></textarea>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-700 text-center">
            <p class="text-sm text-gray-500 dark:text-gray-400">
                Version <span id="app-version">2.0.0</span> | Made with ❤️ by
                <a href="https://ellowdigital.netlify.app" target="_blank" rel="noopener noreferrer"
                    class="font-medium text-indigo-600 hover:text-indigo-500 dark:text-indigo-400 dark:hover:text-indigo-300 underline">
                    EllowDigital
                </a>
            </p>
        </footer>
    </div>

    <!-- === JAVASCRIPT === -->
    <script>
        // --- CONFIGURATION ---
        const APP_VERSION = '2.0.0'; // Define app version
        // 
        //  !!!  CRITICAL: YOU MUST CHANGE THIS  !!!
        //
        //  Replace this placeholder with your REAL public Render URL
        //
        const API_BASE_URL = 'https://my-bulk-messaging-server.onrender.com';
        // 
        //  !!!  CRITICAL: YOU MUST CHANGE THIS  !!!
        //

        const API_ENDPOINT_SEND = `${API_BASE_URL}/send`;
        const API_ENDPOINT_SIGN = `${API_BASE_URL}/api/sign-upload`; // Used for both audio and image

        const PRICING = { sms: 0.50, whatsapp: 0.45, call: 1.00 };
        const CHANNELS = [
            { id: 'sms', name: 'SMS' }, { id: 'whatsapp', name: 'WhatsApp' }, { id: 'call', name: 'Voice Call' }
        ];

        // --- DOM Elements ---
        const DOMElements = {
            // Campaign
            channelSelect: document.getElementById('channel'),
            smsWhatsappOptions: document.getElementById('sms-whatsapp-options-container'),
            voiceCallOptions: document.getElementById('voice-call-options-container'),
            // SMS/WA
            messageTextarea: document.getElementById('message'),
            imageUrlInput: document.getElementById('image-url'), // Now readonly
            imageFilePicker: document.getElementById('image-file-picker'), // NEW
            imagePreview: document.getElementById('image-preview'), // NEW
            imageUploadStatus: document.getElementById('image-upload-status'), // NEW
            imageUploadStatusText: document.getElementById('image-upload-status-text'), // NEW
            // Voice Call
            callTypeTTS: document.getElementById('call-type-tts'),
            callTypeAudio: document.getElementById('call-type-audio'),
            ttsContainer: document.getElementById('tts-container'),
            messageTTSTextarea: document.getElementById('message-tts'),
            audioContainer: document.getElementById('audio-container'),
            audioUrlInput: document.getElementById('audio-url'), // Readonly
            audioPreview: document.getElementById('audio-preview'),
            audioFilePicker: document.getElementById('audio-file-picker'),
            recordButton: document.getElementById('record-button'),
            stopRecordButton: document.getElementById('stop-record-button'),
            recordTimer: document.getElementById('record-timer'),
            audioUploadStatus: document.getElementById('audio-upload-status'), // Renamed ID
            audioUploadStatusText: document.getElementById('audio-upload-status-text'), // Renamed ID
            // Contacts
            countryCodeInput: document.getElementById('country-code'),
            phoneNumberInput: document.getElementById('phone-number'),
            addNumberBtn: document.getElementById('add-number-btn'),
            addNumberFeedback: document.getElementById('add-number-feedback'),
            csvFileInput: document.getElementById('csvFile'),
            fileInfo: document.getElementById('file-info'),
            contactsList: document.getElementById('contacts-list'),
            contactsListContainer: document.getElementById('contacts-list-container'), // Added for validation shake
            contactCount: document.getElementById('contact-count'),
            // Controls
            sendButton: document.getElementById('send-button'),
            pauseResumeButton: document.getElementById('pause-resume-button'),
            stopButton: document.getElementById('stop-button'),
            delaySlider: document.getElementById('delay-slider'),
            delayValue: document.getElementById('delay-value'),
            costEstimator: document.getElementById('cost-estimator'),
            estimatedCost: document.getElementById('estimated-cost'),
            // Status
            statusMessage: document.getElementById('status-message'),
            progressBar: document.getElementById('progress-bar'),
            sentCountEl: document.getElementById('sent-count'),
            totalCountEl: document.getElementById('total-count'),
            logsContainer: document.getElementById('logs'),
            tabLogs: document.getElementById('tab-logs'),
            tabFailures: document.getElementById('tab-failures'),
            tabContentLogs: document.getElementById('tab-content-logs'),
            tabContentFailures: document.getElementById('tab-content-failures'),
            failureCount: document.getElementById('failure-count'),
            failedNumbersTextarea: document.getElementById('failed-numbers'),
            // Theme
            themeToggle: document.getElementById('theme-toggle'),
            lightIcon: document.getElementById('theme-icon-light'),
            darkIcon: document.getElementById('theme-icon-dark'),
            // Footer
            appVersionSpan: document.getElementById('app-version'), // NEW: For version display
        };

        // --- State ---
        let campaign = {
            state: 'idle', // idle, running, paused, stopped, finished
            contacts: new Set(),
            failedNumbers: [],
            currentIndex: 0,
            sentCount: 0,
            timeoutId: null,
        };
        let mediaRecorder;
        let audioChunks = [];
        let recordTimerInterval;
        let recordTimeout; // To store the 30-second timeout

        // --- Initialization ---
        function initialize() {
            setupEventListeners();
            initializeTheme();
            populateChannelSelect();
            updateChannelSpecificUI();
            updateCostEstimator();
            // Display version in footer
            if (DOMElements.appVersionSpan) {
                DOMElements.appVersionSpan.textContent = APP_VERSION;
            }
        }

        function populateChannelSelect() {
            DOMElements.channelSelect.innerHTML = CHANNELS.map(ch => `<option value="${ch.id}">${ch.name}</option>`).join('');
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            // Theme
            DOMElements.themeToggle.addEventListener('click', toggleTheme);
            // Campaign Setup
            DOMElements.channelSelect.addEventListener('change', () => {
                updateChannelSpecificUI();
                updateCostEstimator();
            });
            DOMElements.callTypeTTS.addEventListener('change', updateChannelSpecificUI);
            DOMElements.callTypeAudio.addEventListener('change', updateChannelSpecificUI);
            // Contacts
            DOMElements.csvFileInput.addEventListener('change', handleCsvUpload);
            DOMElements.addNumberBtn.addEventListener('click', handleAddNumber);
            DOMElements.phoneNumberInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleAddNumber();
            });
            // Controls
            DOMElements.sendButton.addEventListener('click', confirmAndStartCampaign);
            DOMElements.pauseResumeButton.addEventListener('click', togglePauseResume);
            DOMElements.stopButton.addEventListener('click', stopCampaign);
            DOMElements.delaySlider.addEventListener('input', e => {
                DOMElements.delayValue.textContent = (e.target.value / 1000).toFixed(1);
            });
            // Status Tabs
            DOMElements.tabLogs.addEventListener('click', () => switchTab('logs'));
            DOMElements.tabFailures.addEventListener('click', () => switchTab('failures'));

            // Media Helper Events - Audio
            DOMElements.audioFilePicker.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    uploadMediaToCloudinary(file, 'audio'); // Specify type
                }
            });
            DOMElements.recordButton.addEventListener('click', startRecording);
            DOMElements.stopRecordButton.addEventListener('click', stopRecording);

            // Media Helper Events - Image (NEW)
            DOMElements.imageFilePicker.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    uploadMediaToCloudinary(file, 'image'); // Specify type
                }
            });
        }

        // --- Contact Management ---
        function handleAddNumber() {
            const countryCode = DOMElements.countryCodeInput.value.trim();
            const phone = DOMElements.phoneNumberInput.value.trim();
            const feedbackEl = DOMElements.addNumberFeedback;
            if (!phone) {
                feedbackEl.textContent = "Phone number cannot be empty.";
                return;
            }
            const fullNumber = countryCode.startsWith('+') ? `${countryCode}${phone}` : `+${countryCode}${phone}`;
            // More robust E.164 validation
            if (!/^\+[1-9]\d{1,14}$/.test(fullNumber)) { // Adjusted max length
                feedbackEl.textContent = `Invalid number format: ${fullNumber}. Use E.164 (e.g., +919876543210)`;
                return;
            }
            if (campaign.contacts.has(fullNumber)) {
                feedbackEl.textContent = "This number has already been added.";
            } else {
                campaign.contacts.add(fullNumber);
                renderContacts();
                updateCostEstimator();
                DOMElements.phoneNumberInput.value = '';
                DOMElements.phoneNumberInput.focus();
                feedbackEl.textContent = '';
            }
        }
        function handleCsvUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            DOMElements.fileInfo.textContent = `File: ${file.name}`;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const text = e.target.result;
                    const rows = text.split(/[\r\n]+/).map(row => row.trim()).filter(Boolean); // Handle different line endings
                    if (rows.length < 2) {
                        addLog("CSV Error: File seems empty or has no data rows.", "error"); return;
                    }
                    // More flexible header detection (case-insensitive, strips quotes)
                    const header = rows[0].split(',').map(h => h.trim().toLowerCase().replace(/^"|"$/g, ''));
                    const phoneIndex = header.indexOf('phone');

                    if (phoneIndex === -1) {
                        addLog("CSV Error: File must have a 'phone' column header.", "error"); return;
                    }

                    const numbersFromCsv = rows.slice(1).map(row => {
                        // Handle potential quotes and extra whitespace around numbers
                        const columns = row.split(',');
                        return columns[phoneIndex]?.trim().replace(/^"|"$/g, '') || '';
                    }).filter(Boolean);

                    let addedCount = 0;
                    let invalidCount = 0;
                    numbersFromCsv.forEach(num => {
                        let cleanNum = num.replace(/\D/g, ''); // Remove non-digits first
                        let formattedNum = num.startsWith('+') ? num : `+${num}`; // Add '+' if missing AFTER cleaning other chars potentially

                        // Re-validate using robust E.164
                        if (/^\+[1-9]\d{1,14}$/.test(formattedNum)) {
                            if (!campaign.contacts.has(formattedNum)) {
                                campaign.contacts.add(formattedNum);
                                addedCount++;
                            }
                        } else {
                            invalidCount++;
                        }
                    });
                    renderContacts();
                    updateCostEstimator();
                    let logMessage = `Loaded from CSV: Added ${addedCount} new unique numbers.`;
                    if (invalidCount > 0) {
                        logMessage += ` Skipped ${invalidCount} invalid numbers.`;
                        addLog(logMessage, "warning");
                    } else {
                        addLog(logMessage, "success");
                    }
                } catch (csvError) {
                    addLog(`Error processing CSV: ${csvError.message}`, "error");
                } finally {
                    // Clear the file input so the same file can be re-uploaded if needed
                    event.target.value = null;
                    DOMElements.fileInfo.textContent = "Upload a CSV with a 'phone' column."; // Reset file info text
                }
            };
            reader.onerror = () => {
                addLog("Error reading the CSV file.", "error");
                event.target.value = null;
                DOMElements.fileInfo.textContent = "Upload a CSV with a 'phone' column.";
            };
            reader.readAsText(file);
        }
        function removeContact(numberToRemove) {
            campaign.contacts.delete(numberToRemove);
            renderContacts();
            updateCostEstimator();
        }
        function renderContacts() {
            DOMElements.contactsList.innerHTML = '';
            const count = campaign.contacts.size;
            DOMElements.contactCount.textContent = count;
            if (count === 0) {
                DOMElements.contactsList.innerHTML = `<p class="text-sm text-gray-500 dark:text-gray-400 p-2 text-center">No contacts added yet.</p>`;
            } else {
                campaign.contacts.forEach(number => {
                    const pill = document.createElement('div');
                    pill.className = 'flex items-center justify-between bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200 text-sm font-medium px-3 py-1.5 rounded-full';
                    pill.innerHTML = `
                        <span>${number}</span>
                        <button class="ml-2 text-indigo-500 hover:text-indigo-700 dark:hover:text-indigo-300 focus-ring rounded-full w-5 h-5 flex items-center justify-center flex-shrink-0" title="Remove ${number}">&times;</button>
                    `; // Added title for accessibility
                    pill.querySelector('button').onclick = (e) => {
                        e.stopPropagation(); // Prevent potential parent clicks
                        removeContact(number);
                    };
                    DOMElements.contactsList.appendChild(pill);
                });
            }
        }

        // --- Media & Cloudinary Logic ---
        async function startRecording() {
            // Check for MediaRecorder support
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia || !window.MediaRecorder) {
                addLog("Audio recording is not supported in this browser.", "error");
                return;
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                // Use a more specific MIME type if available, fallback to default
                const options = { mimeType: 'audio/webm;codecs=opus' };
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    console.warn(`${options.mimeType} not supported, trying default.`);
                    delete options.mimeType; // Use browser default
                }
                mediaRecorder = new MediaRecorder(stream, options);

                audioChunks = [];
                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                mediaRecorder.onstop = () => {
                    // Determine file extension based on MIME type used
                    const mimeType = mediaRecorder.mimeType || 'audio/wav'; // Default if somehow unknown
                    const fileExtension = mimeType.includes('webm') ? 'webm' : 'wav';
                    const audioBlob = new Blob(audioChunks, { type: mimeType });
                    const audioFile = new File([audioBlob], `recording-${new Date().toISOString()}.${fileExtension}`, { type: mimeType });
                    uploadMediaToCloudinary(audioFile, 'audio');
                    addLog("Recording finished. Uploading...", "info");
                    // Clean up stream tracks
                    stream.getTracks().forEach(track => track.stop());
                };
                mediaRecorder.onerror = (event) => {
                    addLog(`Recording Error: ${event.error.message}`, "error");
                    stopRecording(); // Try to cleanup state on error
                };
                mediaRecorder.start();
                DOMElements.recordButton.disabled = true;
                DOMElements.stopRecordButton.disabled = false;
                DOMElements.audioFilePicker.disabled = true;
                startRecordTimer();

                recordTimeout = setTimeout(() => {
                    addLog("Recording automatically stopping after 30 seconds.", "warning");
                    stopRecording();
                }, 30000);

                addLog("Recording started... (max 30 seconds)", "info");
            } catch (err) {
                // Handle specific permission errors
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    addLog("Microphone access denied. Please allow microphone permissions in your browser settings.", "error");
                } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                    addLog("No microphone found. Please connect a microphone.", "error");
                } else {
                    addLog("Error starting recording: " + err.message, "error");
                }
                DOMElements.recordButton.disabled = false;
                DOMElements.stopRecordButton.disabled = true;
                DOMElements.audioFilePicker.disabled = false;
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
            // Stream tracks are stopped in mediaRecorder.onstop
            if (recordTimeout) {
                clearTimeout(recordTimeout);
                recordTimeout = null;
            }
            DOMElements.recordButton.disabled = false;
            DOMElements.stopRecordButton.disabled = true;
            DOMElements.audioFilePicker.disabled = false;
            stopRecordTimer();
        }

        function startRecordTimer() {
            let seconds = 0;
            DOMElements.recordTimer.textContent = '00:00';
            recordTimerInterval = setInterval(() => {
                seconds++;
                if (seconds > 30) {
                    DOMElements.recordTimer.textContent = '00:30';
                    stopRecordTimer();
                    return;
                }
                const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
                const secs = (seconds % 60).toString().padStart(2, '0');
                DOMElements.recordTimer.textContent = `${mins}:${secs}`;
            }, 1000);
        }

        function stopRecordTimer() {
            if (recordTimerInterval) {
                clearInterval(recordTimerInterval);
                recordTimerInterval = null; // Clear interval ID
            }
        }

        // --- Generalized Media Upload Function ---
        async function uploadMediaToCloudinary(file, type) {
            let statusEl, statusTextEl, urlInputEl, previewEl, filePickerEl;

            if (type === 'audio') {
                statusEl = DOMElements.audioUploadStatus;
                statusTextEl = DOMElements.audioUploadStatusText;
                urlInputEl = DOMElements.audioUrlInput;
                previewEl = DOMElements.audioPreview;
                filePickerEl = DOMElements.audioFilePicker;
                statusTextEl.textContent = `Uploading audio ${file.name}...`;
            } else if (type === 'image') {
                statusEl = DOMElements.imageUploadStatus;
                statusTextEl = DOMElements.imageUploadStatusText;
                urlInputEl = DOMElements.imageUrlInput;
                previewEl = DOMElements.imagePreview;
                filePickerEl = DOMElements.imageFilePicker;
                statusTextEl.textContent = `Uploading image ${file.name}...`;

                const reader = new FileReader();
                reader.onload = (e) => {
                    previewEl.src = e.target.result;
                    previewEl.classList.remove('hidden');
                }
                reader.onerror = () => { // Handle preview loading error
                    addLog("Error loading image preview.", "error");
                }
                reader.readAsDataURL(file);
            } else {
                console.error("Invalid type provided to uploadMediaToCloudinary");
                return;
            }

            statusEl.classList.remove('hidden');
            statusEl.classList.add('flex');
            urlInputEl.value = '';
            filePickerEl.disabled = true; // Disable picker during upload

            try {
                const signResponse = await fetch(`${API_ENDPOINT_SIGN}?type=${type}`);
                if (!signResponse.ok) {
                    let errorMsg = 'Could not get upload signature from server.';
                    try { // Try to parse JSON error from backend
                        const errJson = await signResponse.json();
                        errorMsg = errJson.error || errorMsg;
                    } catch (_) { /* Ignore parsing error, use default message */ }
                    throw new Error(errorMsg);
                }
                const signData = await signResponse.json();

                const formData = new FormData();
                formData.append('file', file);
                formData.append('api_key', signData.apiKey);
                formData.append('timestamp', signData.timestamp);
                formData.append('signature', signData.signature);
                formData.append('folder', signData.folder); // Use folder from backend response

                const resourceType = type === 'image' ? 'image' : 'video';
                const uploadUrl = `https://api.cloudinary.com/v1_1/${signData.cloudName}/${resourceType}/upload`;

                const uploadResponse = await fetch(uploadUrl, {
                    method: 'POST',
                    body: formData,
                });

                if (!uploadResponse.ok) {
                    let errorMsg = 'Cloudinary upload failed.';
                    try { // Try to parse JSON error from Cloudinary
                        const errJson = await uploadResponse.json();
                        errorMsg = errJson.error?.message || errorMsg;
                    } catch (_) { /* Ignore parsing error */ }
                    throw new Error(errorMsg);
                }
                const uploadData = await uploadResponse.json();

                const publicUrl = uploadData.secure_url;
                urlInputEl.value = publicUrl;

                if (type === 'audio') {
                    previewEl.src = publicUrl;
                }

                addLog(`${type.charAt(0).toUpperCase() + type.slice(1)} successfully uploaded.`, "success");
                statusTextEl.textContent = "Upload complete!";
                setTimeout(() => {
                    statusEl.classList.add('hidden');
                }, 2000);

            } catch (error) {
                console.error("Upload failed:", error);
                addLog(`Upload Failed (${type}): ${error.message}`, "error");
                statusTextEl.textContent = `Upload failed.`; // Keep it concise for UI
                if (type === 'image') {
                    previewEl.classList.add('hidden');
                    previewEl.src = '';
                }
                // Do NOT hide status on failure
            } finally {
                filePickerEl.disabled = false; // Re-enable picker
                filePickerEl.value = null; // Clear file input
            }
        }


        // --- Core Campaign Logic ---
        function confirmAndStartCampaign() {
            if (!validateInputs()) return;
            const contactCount = campaign.contacts.size;
            const estimatedCost = calculateCost(contactCount);
            // Using a custom modal might be better, but window.confirm is simple
            if (window.confirm(`Start campaign for ${contactCount} contacts?\nEstimated cost: ₹${estimatedCost.toFixed(2)}.\n\nProceed?`)) {
                startCampaign();
            }
        }

        function validateInputs() {
            if (campaign.contacts.size === 0) {
                addLog("Validation Error: No contacts added.", "error");
                DOMElements.contactsListContainer.classList.add('shake');
                setTimeout(() => DOMElements.contactsListContainer.classList.remove('shake'), 500);
                return false;
            }

            const channel = DOMElements.channelSelect.value;
            if (channel === 'call') {
                const callType = document.querySelector('input[name="call-type"]:checked').value;
                if (callType === 'tts' && !DOMElements.messageTTSTextarea.value.trim()) {
                    addLog("Validation Error: TTS message required.", "error");
                    DOMElements.messageTTSTextarea.focus(); // Focus the field
                    DOMElements.messageTTSTextarea.classList.add('shake');
                    setTimeout(() => DOMElements.messageTTSTextarea.classList.remove('shake'), 500);
                    return false;
                } else if (callType === 'audio' && !DOMElements.audioUrlInput.value.trim()) {
                    addLog("Validation Error: Audio URL required. Upload or record first.", "error");
                    DOMElements.audioFilePicker.focus(); // Focus the general area
                    DOMElements.audioContainer.classList.add('shake');
                    setTimeout(() => DOMElements.audioContainer.classList.remove('shake'), 500);
                    return false;
                }
            } else { // SMS or WhatsApp
                if (!DOMElements.messageTextarea.value.trim() && !DOMElements.imageUrlInput.value.trim()) {
                    addLog("Validation Error: Message or Image required.", "error");
                    DOMElements.messageTextarea.focus();
                    DOMElements.messageTextarea.classList.add('shake');
                    DOMElements.imageFilePicker.parentElement.classList.add('shake');
                    setTimeout(() => {
                        DOMElements.messageTextarea.classList.remove('shake');
                        DOMElements.imageFilePicker.parentElement.classList.remove('shake');
                    }, 500);
                    return false;
                }
            }
            return true; // All checks passed
        }

        function startCampaign() {
            resetCampaignState(); // Ensure clean state before starting
            const numbersArray = Array.from(campaign.contacts);
            if (numbersArray.length === 0) return; // Should be caught by validation, but double-check

            campaign.state = 'running';
            campaign.totalCount = numbersArray.length;
            updateUIForCampaignStart(); // Disables inputs, enables controls
            addLog(`Starting campaign: ${campaign.totalCount} messages via ${DOMElements.channelSelect.value.toUpperCase()}.`);

            // Start sending the first message immediately
            sendNextMessage(numbersArray);
        }

        async function sendNextMessage(numbers) {
            // Check state before proceeding
            if (campaign.state !== 'running') {
                console.log("sendNextMessage called but campaign state is not 'running'. Finishing.");
                // Ensure campaign finishes if stopped/paused during async operation
                if (campaign.currentIndex >= campaign.totalCount && campaign.state !== 'finished' && campaign.state !== 'stopped') {
                    finishCampaign();
                }
                return;
            }
            if (campaign.currentIndex >= campaign.totalCount) {
                finishCampaign(); // All messages processed
                return;
            }

            const number = numbers[campaign.currentIndex];
            const channel = DOMElements.channelSelect.value;

            const payload = { channel, recipient: number };

            if (channel === 'call') {
                const callType = document.querySelector('input[name="call-type"]:checked').value;
                payload.callType = callType;
                if (callType === 'tts') payload.message = DOMElements.messageTTSTextarea.value;
                else payload.audioUrl = DOMElements.audioUrlInput.value.trim();
            } else {
                const message = DOMElements.messageTextarea.value;
                const imageUrl = DOMElements.imageUrlInput.value.trim();
                if (message) payload.message = message;
                if (imageUrl) payload.imageUrl = imageUrl;
            }

            let success = false;
            let sid = null;
            let errorMessage = 'Unknown error';

            try {
                const response = await fetch(API_ENDPOINT_SEND, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, // Added Accept header
                    body: JSON.stringify(payload),
                });

                // Check for non-JSON responses (like HTML error pages)
                const contentType = response.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    errorMessage = `Server returned non-JSON response (Status: ${response.status})`;
                    console.error(errorMessage, await response.text()); // Log the raw response
                    throw new Error(errorMessage);
                }

                const result = await response.json();

                if (!response.ok) {
                    errorMessage = result.error || `HTTP error! Status: ${response.status}`;
                    throw new Error(errorMessage);
                }

                success = true;
                sid = result.sid;
                campaign.sentCount++; // Increment only on success
                addLog(`Success: ${number} (SID: ${sid})`, 'success');

            } catch (error) {
                errorMessage = error.message; // Use the caught error message
                console.error(`Error sending to ${number}:`, error); // Log the full error object
                addLog(`Failed: ${number} (${errorMessage})`, 'error');
                campaign.failedNumbers.push(number);
                updateFailuresTab();
            } finally {
                // Always advance index and update progress, regardless of success/fail
                campaign.currentIndex++;
                updateProgress();

                // Schedule next message only if campaign is still running
                if (campaign.state === 'running' && campaign.currentIndex < campaign.totalCount) {
                    const delay = parseInt(DOMElements.delaySlider.value, 10);
                    campaign.timeoutId = setTimeout(() => sendNextMessage(numbers), delay);
                } else if (campaign.state === 'running' && campaign.currentIndex >= campaign.totalCount) {
                    // If this was the last message, finish the campaign
                    finishCampaign();
                }
            }
        }

        // --- Campaign Controls & UI Updates ---
        function togglePauseResume() {
            if (campaign.state === 'running') {
                campaign.state = 'paused';
                if (campaign.timeoutId) clearTimeout(campaign.timeoutId); // Clear scheduled next message
                campaign.timeoutId = null;
                updateUIForPause();
                addLog('Campaign paused.', 'warning');
            } else if (campaign.state === 'paused') {
                campaign.state = 'running';
                updateUIForResume();
                addLog('Campaign resumed.');
                const numbersArray = Array.from(campaign.contacts);
                // Immediately attempt to send the *next* message in sequence
                sendNextMessage(numbersArray);
            }
        }
        function stopCampaign() {
            if (campaign.state === 'running' || campaign.state === 'paused') {
                const previousState = campaign.state;
                campaign.state = 'stopped'; // Set state immediately
                if (campaign.timeoutId) clearTimeout(campaign.timeoutId);
                campaign.timeoutId = null;

                if (previousState === 'running' || previousState === 'paused') {
                    addLog('Campaign stopped by user.', 'error');
                }
                finishCampaign(); // Finalize UI updates etc.
            }
        }
        function finishCampaign() {
            // Only proceed if not already finished/stopped
            if (campaign.state === 'finished' || campaign.state === 'stopped') {
                // Determine the final state message
                const finalStateMsg = campaign.state;
                if (campaign.state !== 'stopped') { // If naturally finished
                    campaign.state = 'finished';
                }
                addLog(`Campaign ${finalStateMsg}. Processed ${campaign.currentIndex} of ${campaign.totalCount}. Success: ${campaign.sentCount}, Failures: ${campaign.failedNumbers.length}.`, 'info');
                updateUIForCampaignEnd();

            }
        }
        function updateUIForCampaignStart() {
            DOMElements.statusMessage.textContent = 'Running...';
            DOMElements.totalCountEl.textContent = campaign.totalCount;
            DOMElements.sentCountEl.textContent = '0';
            DOMElements.progressBar.style.width = '0%';
            DOMElements.logsContainer.innerHTML = '';
            DOMElements.failedNumbersTextarea.value = '';
            DOMElements.failureCount.textContent = '0';

            const elementsToDisable = [
                DOMElements.sendButton, DOMElements.channelSelect,
                DOMElements.messageTextarea, DOMElements.imageUrlInput, DOMElements.imageFilePicker,
                DOMElements.addNumberBtn, DOMElements.csvFileInput,
                DOMElements.messageTTSTextarea, DOMElements.audioUrlInput, DOMElements.audioFilePicker,
                DOMElements.recordButton, DOMElements.stopRecordButton,
                DOMElements.callTypeTTS, DOMElements.callTypeAudio,
                DOMElements.countryCodeInput, DOMElements.phoneNumberInput,
                DOMElements.delaySlider // Also disable slider during run
            ];
            elementsToDisable.forEach(el => { if (el) el.disabled = true; });

            DOMElements.contactsList.querySelectorAll('button').forEach(btn => btn.disabled = true);

            DOMElements.pauseResumeButton.disabled = false;
            DOMElements.stopButton.disabled = false;

            // Reset pause button to initial state
            DOMElements.pauseResumeButton.querySelector('span').textContent = 'Pause';
            DOMElements.pauseResumeButton.classList.remove('bg-green-500', 'hover:bg-green-600');
            DOMElements.pauseResumeButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
        }
        function updateUIForPause() {
            DOMElements.pauseResumeButton.querySelector('span').textContent = 'Resume';
            DOMElements.pauseResumeButton.classList.replace('bg-yellow-500', 'bg-green-500');
            DOMElements.pauseResumeButton.classList.replace('hover:bg-yellow-600', 'hover:bg-green-600');
            DOMElements.statusMessage.textContent = 'Paused';
        }
        function updateUIForResume() {
            DOMElements.pauseResumeButton.querySelector('span').textContent = 'Pause';
            DOMElements.pauseResumeButton.classList.replace('bg-green-500', 'bg-yellow-500');
            DOMElements.pauseResumeButton.classList.replace('hover:bg-green-600', 'hover:bg-yellow-600');
            DOMElements.statusMessage.textContent = 'Running...';
        }
        function updateUIForCampaignEnd() {
            DOMElements.statusMessage.textContent = campaign.state === 'stopped' ? 'Stopped' : 'Finished';

            const elementsToEnable = [
                DOMElements.sendButton, DOMElements.channelSelect,
                DOMElements.messageTextarea, DOMElements.imageUrlInput, DOMElements.imageFilePicker,
                DOMElements.addNumberBtn, DOMElements.csvFileInput,
                DOMElements.messageTTSTextarea, DOMElements.audioUrlInput, DOMElements.audioFilePicker,
                DOMElements.recordButton,
                // Stop button remains disabled until recording starts
                DOMElements.callTypeTTS, DOMElements.callTypeAudio,
                DOMElements.countryCodeInput, DOMElements.phoneNumberInput,
                DOMElements.delaySlider // Re-enable slider
            ];
            elementsToEnable.forEach(el => { if (el) el.disabled = false; });

            DOMElements.stopRecordButton.disabled = true; // Ensure stop recording is disabled initially

            DOMElements.contactsList.querySelectorAll('button').forEach(btn => btn.disabled = false);

            DOMElements.pauseResumeButton.disabled = true;
            DOMElements.stopButton.disabled = true;
            // Reset pause button visual state
            DOMElements.pauseResumeButton.querySelector('span').textContent = 'Pause';
            DOMElements.pauseResumeButton.classList.remove('bg-green-500', 'hover:bg-green-600');
            DOMElements.pauseResumeButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
        }
        function resetCampaignState() {
            if (campaign.timeoutId) clearTimeout(campaign.timeoutId);
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                stopRecording(); // Properly stop recording if interrupted
            }
            campaign.state = 'idle';
            campaign.failedNumbers = [];
            campaign.currentIndex = 0;
            campaign.sentCount = 0;
            campaign.totalCount = 0; // Reset total count as well
            campaign.timeoutId = null;

            // Also reset UI elements related to a running campaign state
            updateProgress(); // Reset progress bar and counts
            DOMElements.statusMessage.textContent = 'Idle. Configure a campaign to begin.';
            updateUIForCampaignEnd(); // Re-enable inputs, disable controls
        }
        function updateProgress() {
            const currentDisplay = Math.min(campaign.currentIndex, campaign.totalCount);
            const totalDisplay = campaign.totalCount; // Use the stored total count
            DOMElements.sentCountEl.textContent = currentDisplay;
            DOMElements.totalCountEl.textContent = totalDisplay; // Update total count display too
            const progress = totalDisplay > 0 ? (currentDisplay / totalDisplay) * 100 : 0;
            DOMElements.progressBar.style.width = `${progress}%`;
        }
        function updateFailuresTab() {
            DOMElements.failureCount.textContent = campaign.failedNumbers.length;
            DOMElements.failedNumbersTextarea.value = campaign.failedNumbers.join('\n');
        }

        // --- Helpers & Utilities ---
        function calculateCost(numberCount) {
            const pricePerUnit = PRICING[DOMElements.channelSelect.value] || 0;
            return numberCount * pricePerUnit;
        }
        function updateCostEstimator() {
            const contactCount = campaign.contacts.size;
            const totalCost = calculateCost(contactCount);
            DOMElements.estimatedCost.textContent = `₹${totalCost.toFixed(2)}`;
        }

        function updateChannelSpecificUI() {
            const selectedChannel = DOMElements.channelSelect.value;

            if (selectedChannel === 'call') {
                DOMElements.smsWhatsappOptions.classList.add('hidden');
                DOMElements.voiceCallOptions.classList.remove('hidden');

                // Ensure correct sub-options are shown based on radio selection
                const callType = document.querySelector('input[name="call-type"]:checked').value;
                if (callType === 'tts') {
                    DOMElements.ttsContainer.classList.remove('hidden');
                    DOMElements.audioContainer.classList.add('hidden');
                } else {
                    DOMElements.ttsContainer.classList.add('hidden');
                    DOMElements.audioContainer.classList.remove('hidden');
                }
            } else { // SMS or WhatsApp
                DOMElements.smsWhatsappOptions.classList.remove('hidden');
                DOMElements.voiceCallOptions.classList.add('hidden');
            }
        }

        function addLog(message, type = 'info') {
            const p = document.createElement('p');
            const typeClasses = {
                error: 'text-red-500 dark:text-red-400',
                success: 'text-green-600 dark:text-green-400',
                warning: 'text-yellow-500 dark:text-yellow-400',
                info: 'text-gray-600 dark:text-gray-300'
            };
            p.className = `text-sm ${typeClasses[type] || typeClasses['info']} break-words`;
            // Sanitize message slightly before inserting (basic protection)
            const sanitizedMessage = message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            p.innerHTML = `<span class="font-mono text-xs mr-2 opacity-70">[${new Date().toLocaleTimeString()}]</span> ${sanitizedMessage}`;
            DOMElements.logsContainer.prepend(p);
        }
        function switchTab(tab) {
            const activeClasses = ['border-indigo-500', 'text-indigo-600', 'dark:text-indigo-400'];
            // Combine all possible inactive classes
            const inactiveClasses = ['border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300', 'dark:text-gray-400', 'dark:hover:text-gray-200'];

            const logsTab = DOMElements.tabLogs;
            const failuresTab = DOMElements.tabFailures;
            const logsContent = DOMElements.tabContentLogs;
            const failuresContent = DOMElements.tabContentFailures;

            // Reset both tabs to inactive state first
            logsTab.classList.remove(...activeClasses);
            logsTab.classList.add(...inactiveClasses);
            failuresTab.classList.remove(...activeClasses);
            failuresTab.classList.add(...inactiveClasses);

            // Hide both content areas
            logsContent.classList.add('hidden');
            failuresContent.classList.add('hidden');

            // Apply active state to the selected tab and content
            if (tab === 'logs') {
                logsContent.classList.remove('hidden');
                logsTab.classList.add(...activeClasses);
                logsTab.classList.remove(...inactiveClasses.filter(cls => !activeClasses.includes(cls))); // Ensure only inactive classes are removed
            } else {
                failuresContent.classList.remove('hidden');
                failuresTab.classList.add(...activeClasses);
                failuresTab.classList.remove(...inactiveClasses.filter(cls => !activeClasses.includes(cls)));
            }
        }
        function initializeTheme() {
            const isDark = localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
            document.documentElement.classList.toggle('dark', isDark);
            DOMElements.lightIcon.classList.toggle('hidden', isDark);
            DOMElements.darkIcon.classList.toggle('hidden', !isDark);
        }
        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.theme = isDark ? 'dark' : 'light';
            initializeTheme(); // Re-apply classes based on new state
        }

        // --- Start the App ---
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>

</html>